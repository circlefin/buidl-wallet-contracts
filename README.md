# buidl-wallet-contracts
Official repository for all smart wallet contracts used by Circle web3 API/SDK. 

This repository includes support for both the Hardhat and Foundry frameworks. Going forward, all new code / tests / scripts should be built on Foundry. Hardhat is currently only included for legacy contracts in the following folders:
- `src/account/v1`
- `src/paymaster/v1/permissioned`

## Setup
1. Run `git submodule update --init --recursive` to update/download all libraries.
2. Run `yarn install` to install any additional dependencies.
3. Run `curl -L https://foundry.paradigm.xyz | bash` and follow the outputted instructions to source env file. 
4. Run `foundryup`
5. Create a `.env` file and provide the required API keys, wallets (can be generated for deployment), and configuration values. You can look at the `.env.example` for reference.

## Development

### Lint
Run `yarn lint` to lint all `.sol` files in the `src` and `test` directories.

### Test
To run tests using Foundry, follow the steps below:
1. Run `yarn build`
2. Run `yarn test`

### Test Coverage
To generate a viewable test coverage report, run:
- `brew install lcov` if not yet installed
- `forge coverage --ir-minimum --report lcov && genhtml lcov.info -o report --branch-coverage && open report/index.html`
(Note: some contracts like WeightedMultisigPlugin require using --ir-minimum because of stack depth. To build coverage
faster locally, comment out this and dependent contracts and omit --ir-minimum flag.)


### Continuous Integration
We use Github actions to run linter and all the tests. The workflow configuration can be found in [.github/workflows/ci.yml](.github/workflows/ci.yml)


### Release
We are using [Conventional Commit](https://www.conventionalcommits.org/en/v1.0.0/) structure to automatically generate releases.

## Export Interface
To export contract bytecode & ABI for programmable wallet:
1. Execute `forge build src/msca/6900/v0.7 --force --extra-output-files abi evm`. Replace v0.7 with v0.8 if you want v0.8.
2. Execute `make abigen`
3. Interface files will appear under `abigen` folder
4. After changes are merged, release new repository tag
5. update `buidl-wallet-contracts` go mod version of programmable-wallet, and import bytecode from `abigen` folder

For running integration tests in Anvil node, run `make anvil-tests`. This runs the python tests in [test/anvil](test/anvil/)

## Gas Report
### Function report
* Run `yarn build`
* Run `yarn gasreport`

### E2E gas benchmarking
* `anvil`
* update `.env` (pointing to local) and `source .env`
* deploy (only choose the account type you're interested in benchmarking)
  * `forge script script/<SCRIPT_NAME> --rpc-url $RPC_URL --broadcast --verify -vvvv --slow --watch`

    Example: `forge script script/001_DeployPluginManager.s.sol --rpc-url $RPC_URL --broadcast --verify -vvvv --slow --watch`

* `cast code $address`

## Chain Expansion Guide

This section explains how to expand the existing smart contracts to new blockchains.

### Prerequisites
#### Fund deployer and owner
Make sure there are enough native tokens for the new chain in the deployer address (for contract deployment) and temporary owner
address (for setup and stake). Otherwise, you may hit `insufficient fund` error at any step.

#### Add new blockchain RPC URLs to foundry
1. Add new blockchain to `[rpc_endpoints]` in `foundry.toml` following the format of `blockchain_a = ${BLOCKCHAIN_A_RPC_URL}`
2. Update `.env.example` with the new RPC URL env var (e.g. `BLOCKCHAIN_A_RPC_URL`), also update your local `.env` to set up the new env var (e.g. `BLOCKCHAIN_A_RPC_URL=https://blockchaina.rpc.com`).
3. Add new blockchain (e.g. `"blockchain_a"`) to `getChains()` function in `./script/bytecode-deploy/100_Constants.sol`.
4. Since the length of `getChains()` changed above, update the length of local chain list generated by `getChains()` in deployment scripts.


### Deploy & Verify EPv0.6 SponsorPaymaster
Deploy, setup and verify SponsorPaymaster compatible with ERC-4337 v0.6.

#### Run deploy command
Note that deploy commands attempt to deploy on all chains listed in foundry.toml.

```shell
forge script script/bytecode-deploy/101_DeploySponsorPaymaster.s.sol  -vvvv --slow --broadcast --force --multi
```

#### Setup SponsorPaymaster

Need to use block explorer to run `addStake` and `setVerifyingSigner` from owner address.

#### Verify SponsorPaymaster

Use `script/bytecode-deploy/standard-json-input/SponsorPaymaster.json` to verify. Select the following options
in block explorers verify contract UI:
* Compiler Type: `Solidity(Standard-Json-Input)`
* Compiler Version: `v0.8.17`
* License Type: `GNU GPLv3`

### Deploy & Verify SingleOwnerMSCAFactory
Deploy, setup and verify SingleOwnerMSCAFactory compatible with ERC-4337 v0.6.

#### Run deploy commands:
Note that deploy commands attempt to deploy on all chains listed in foundry.toml.

```shell
# Deploy PluginManager
forge script script/bytecode-deploy/102_DeployPluginManager.s.sol  -vvvv --slow --broadcast --force --multi

# Deploy SingleOwnerMSCAFactory
forge script script/bytecode-deploy/102_DeploySingleOwnerMSCAFactory.s.sol  -vvvv --slow --broadcast --force --multi

# Deploy ColdStorageAddressBookPlugin
forge script script/bytecode-deploy/104_DeployColdStorageAddressBookPlugin.s.sol  -vvvv --slow --broadcast --force --multi
```

#### Verify contracts on block explorers.
Use the json files in `script/bytecode-deploy/standard-json-input` to verify smart contracts. If the smart contract has
constructor arguments, it's recorded in `*_constructor_arg` files. Select the following options in block explorers verify contract UI:
* Compiler Type: `Solidity(Standard-Json-Input)`
* Compiler Version: `v0.8.24`
* License Type: `GNU GPLv3`

## Troubleshooting
#### 1. `make: *** [test] Error 137`

If you encountered this error after executing `make test`, try increasing memory resource for docker engine.

#### 2. Encounter `ERROR: failed to solve: operating system is not supported` when executing `make build`
If you are using macbook with M1 or newer chips, try enabling `Use Rosetta for x86/amd64 emulation on Apple Silicon` under `Features in development` in Docker settings.

#### 3. Docker container `foundry:latest` not found
As an alternative to the above, if you are using macbook with M1 or newer chips, try adding the `--platform=linux/amd64` flag to the `build` Make command. If you encounter this error while running `make anvil`, make sure to run `make` before.

#### 4. API key errors when running deploy scripts on a local blockchain
When deploying contract deployment scripts from the `/script` folder on a local chain (started up using `make anvil`), you can remove the `--verify` flag if you are getting errors related to the API key, such as `Missing etherscan key for chain 31337`.

#### 5. failed to read artifact source file for ...

Run `forge clean && forge build`.
